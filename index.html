<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Interactive Choropleth Map</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://d3js.org/topojson.v3.min.js"></script>

  <style>
    .state {
      fill: lightgrey;
      stroke: white;
      stroke-width: 1px;
    }

    .highlight {
      fill: #ADD8E6;
    }
    .tooltip {
      pointer-events: none;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <div style="display: flex; align-items: flex-start;">
    <!-- Map Container with Fixed Width -->
    <div style="width: 900px;">
      <svg id="map" width="900" height="600"></svg>
    </div>
  
    <!-- Logo Container to the Right of the Map -->
    <div id="logo-container" style="width: 150px; margin-left: 20px; display: flex; align-items: center; justify-content: center;">
      <img id="fast-food-logo" src="" alt="Fast Food Logo" style="display: none; width: 100px; height: 100px;">
    </div>
  </div>

  <script>
    const svg = d3.select("#map");
    const width = svg.attr("width");
    const height = svg.attr("height");
    
    // Define color scale for density
    const colorScale = d3.scaleQuantize()
      .domain([0, 100])  // Adjust based on density range
      .range(d3.schemeBlues[9]);

    // Define state names lookup based on FIPS codes
    const stateNames = {
      "01": "Alabama", "02": "Alaska", "04": "Arizona", "05": "Arkansas", "06": "California",
      "08": "Colorado", "09": "Connecticut", "10": "Delaware", "11": "District of Columbia",
      "12": "Florida", "13": "Georgia", "15": "Hawaii", "16": "Idaho", "17": "Illinois",
      "18": "Indiana", "19": "Iowa", "20": "Kansas", "21": "Kentucky", "22": "Louisiana",
      "23": "Maine", "24": "Maryland", "25": "Massachusetts", "26": "Michigan", "27": "Minnesota",
      "28": "Mississippi", "29": "Missouri", "30": "Montana", "31": "Nebraska", "32": "Nevada",
      "33": "New Hampshire", "34": "New Jersey", "35": "New Mexico", "36": "New York",
      "37": "North Carolina", "38": "North Dakota", "39": "Ohio", "40": "Oklahoma", "41": "Oregon",
      "42": "Pennsylvania", "44": "Rhode Island", "45": "South Carolina", "46": "South Dakota",
      "47": "Tennessee", "48": "Texas", "49": "Utah", "50": "Vermont", "51": "Virginia",
      "53": "Washington", "54": "West Virginia", "55": "Wisconsin", "56": "Wyoming"
    };

    const loadData = async function() {
      const us = await d3.json("datasets/us.json");  // Load the TopoJSON file
      const states = topojson.feature(us, us.objects.states);  // Extract state features
      const projection = d3.geoAlbersUsa().fitSize([width, height], states);
      const path = d3.geoPath().projection(projection);

      let mergedData = [];

      Promise.all([
      d3.csv("datasets/fast_food.csv"),
      d3.csv("datasets/obesity_race.csv"),
      d3.csv("datasets/obesity_sex.csv")
    ]).then(([foodData, raceData, sexData]) => {

      foodData.forEach(d => {
        d.ranking = d.MostPopularFastFoodMostSearchedFor;
        const [first, second, third] = d.MostPopularFastFoodMostSearchedFor.replace(/\\n/g, "\n")
          .split("\n").map(item => item.trim())
          .map(item => item.replace(/^\d+\.\s*/, ''));
        d.first = first;
        d.second = second;
        d.third = third;
        delete d.MostPopularFastFoodMostSearchedFor;
        delete d.MostPopularFastFoodBestIconicChain;
        delete d.MostPopularFastFoodFavoriteBreakfast;
        delete d.MostPopularFastFoodTopRatedChain;
      });

      // Process each dataset into a map for easier lookup by state
      const foodMap = {};
      foodData.forEach(d => {
        foodMap[d.state] = d;
      });

      const raceMap = {};
      raceData.forEach(d => {
        raceMap[d.state] = d;
      });

      const sexMap = {};
      sexData.forEach(d => {
        sexMap[d.state] = d;
      });

      // Merge datasets based on the "state" key
      Object.keys(foodMap).forEach(state => {
        const mergedEntry = {
          state: state.padStart(2, '0'),
          ...foodMap[state],
          ...raceMap[state],
          ...sexMap[state]
        };
        mergedData.push(mergedEntry);
      });

      console.log(mergedData); // To verify the merged data structure
    });

      // Append the state paths first
      svg.append("g")
         .selectAll("path")
         .data(states.features)
         .join("path")
         .attr("class", "state")
         .attr("d", path)
         .attr("fill", d => colorScale(d.properties.density || 0))
         .on("mouseover", function(event, d) {
          d3.select(this).attr("class", "highlight");
          const stateID = d.id.toString().padStart(2, '0');  // Format ID with leading zero if needed

          // Retrieve the state name using stateNames
          const stateName = stateNames[stateID] || "Unknown";

          // Find the object in mergedData where the `state` property matches `stateName`
          const stateData = mergedData.find(entry => entry.state === stateName);
          const topFastFood = stateData ? stateData.first : "Not Available";

          // Position tooltip at the state's centroid
          let [x, y] = path.centroid(d);
          const transform = d3.zoomTransform(svg.node());
          
          // Adjust tooltip position to stay within the SVG boundaries
          const tooltipWidth = 180;  // Match tooltip rect width
          const tooltipHeight = 50;  // Match tooltip rect height
          const svgWidth = +svg.attr("width");
          const svgHeight = +svg.attr("height");

          // Apply zoom transformation and adjust to prevent overflow
          x = transform.applyX(x);
          y = transform.applyY(y);

          if (x + tooltipWidth / 2 > svgWidth) {
            x -= tooltipWidth / 2;  // Shift left if tooltip overflows right
          } else if (x - tooltipWidth / 2 < 0) {
            x += tooltipWidth / 2;  // Shift right if tooltip overflows left
          }

          if (y + tooltipHeight > svgHeight) {
            y -= tooltipHeight;  // Shift up if tooltip overflows bottom
          }

          tooltip.style("visibility", "visible")
                .attr("transform", `translate(${x},${y})`);

          tooltipText.text(stateName);
          tooltipSubText.text(`Top Fast Food: ${topFastFood}`);

          // Update the logo image
          const logoImg = document.getElementById("fast-food-logo");
          if (topFastFood === "McDonald's") {
            logoImg.src = "logos/mcdonalds_logo.png";  // Set to McDonald's logo
            logoImg.style.display = "block";       // Show the logo
          } else {
            logoImg.style.display = "none";        // Hide the logo if not McDonald's
          }
        })
        .on("mousemove", function(event, d) {
          // Calculate the position with dynamic adjustments
          let [x, y] = path.centroid(d);
          const transform = d3.zoomTransform(svg.node());

          const tooltipWidth = 180;  // Match tooltip rect width
          const tooltipHeight = 50;  // Match tooltip rect height
          const svgWidth = +svg.attr("width");
          const svgHeight = +svg.attr("height");

          x = transform.applyX(x);
          y = transform.applyY(y);

          if (x + tooltipWidth / 2 > svgWidth) {
            x -= tooltipWidth / 2;  // Shift left if tooltip overflows right
          } else if (x - tooltipWidth / 2 < 0) {
            x += tooltipWidth / 2;  // Shift right if tooltip overflows left
          }

          if (y + tooltipHeight > svgHeight) {
            y -= tooltipHeight;  // Shift up if tooltip overflows bottom
          }

          tooltip.attr("transform", `translate(${x},${y})`);
        })
         .on("mouseout", function() {
           tooltip.style("visibility", "hidden");
           d3.select(this).attr("class", "state");

           // Hide the logo on mouse out
           document.getElementById("fast-food-logo").style.display = "none";
         });

      // Append the tooltip last to bring it to the front
      const tooltip = svg.append("g")
                   .attr("class", "tooltip")
                   .style("visibility", "hidden");

      tooltip.append("rect")
            .attr("width", 180)  // Increased width for better spacing
            .attr("height", 50)  // Increased height to accommodate two lines of text
            .attr("fill", "black")
            .attr("rx", 4)
            .attr("ry", 4)
            .attr("x", -90)      // Centered the tooltip rectangle horizontally
            .attr("y", -40)      // Adjusted vertical position
            .attr("opacity", 0.8);

      const tooltipText = tooltip.append("text")
                                .attr("x", 0)
                                .attr("y", -20)  // Position the state name higher
                                .attr("text-anchor", "middle")
                                .attr("fill", "white")
                                .attr("font-size", "14px")  // Larger font size for the state name
                                .attr("font-weight", "bold");  // Bold font for the state name

      const tooltipSubText = tooltip.append("text")
                                    .attr("x", 0)
                                    .attr("y", 0)  // Position the fast food name lower for padding
                                    .attr("text-anchor", "middle")
                                    .attr("fill", "white")
                                    .attr("font-size", "12px");

      const tooltipImage = tooltip.append("image")  // Image element for the logo
                                    .attr("x", -15)    // Position the image
                                    .attr("y", 10)
                                    .attr("width", 30)
                                    .attr("height", 30)
                                    .style("visibility", "hidden");

    // Set up zoom and pan
    const zoom = d3.zoom()
      .scaleExtent([1, 8])
      .on("zoom", (event) => svg.selectAll("g").attr("transform", event.transform));
    svg.call(zoom);
    };
    
    loadData();
  </script>
</body>
</html>



